<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversations and Messages</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            height: 100vh;
            margin: 0;
            overflow-y: hidden;
        }

        .conversation-list {
            width: 100%;
            height: 90vh;
            overflow-y: scroll;
        }

        .messages {
            width: 100%;
            height: 85%;
            overflow-y: scroll;
        }

        .fixed-size-textarea {
            height: 100%;
            resize: none;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Left Side: Conversations -->
            <div class="col-3 border-right">
                <div class="text-center mb-3">
                    <button class="btn btn-primary account-details">Account Details</button>
                    <button class="btn btn-primary" id="newConversationButton">New Conversation</button>
                    <button class="btn btn-danger" id="logout-btn">Logout</button>
                </div>
                <div class="list-group conversation-list" id="conversationList">
                    <!-- Conversation items will be dynamically added here -->
                </div>
            </div>
            <!-- Right Side: container for Messages and Action Buttons -->
            <div class="col-9" style="height: 100vh;">
                <!-- Container for Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary invite-to-conversation">Invite to Conversation</button>
                    <button class="btn btn-warning leave-conversation">Leave Conversation</button>
                    <button class="btn btn-danger delete-conversation">Delete Conversation</button>
                </div>
                <!-- Scrollable container for Messages -->
                <div class="messages">
                    <!-- Messages for the selected conversation will be displayed here -->
                </div>
                <!-- Container for Text Area and Send Button -->
                <div class="message-input" style="display: flex; flex-direction: row;">
                    <textarea class="form-control fixed-size-textarea" id="text-area"></textarea>
                    <button class="btn btn-success send-message" id="send-btn">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        var selectedConversationId = -1;

        // La incarcarea documentului se extrag si se pun in pagina conversatiile
        $(document).ready(() => {
            $.ajax({
                type: "GET",
                url: "/conversations/get",
                contentType: "application/json",
                success: conversations => {
                    // Get the conversation list container
                    const conversationList = $("#conversationList");

                    // Dynamically add conversation items
                    conversations.forEach(conversation => {
                        const listItem = $(
                            "<p class='list-group-item list-group-item-action'></p>"
                        ).text(conversation.conversationName);
                        listItem.attr('id', conversation.id);
                        conversationList.append(listItem);
                    });
                },
                error: () => {
                    console.error("error fetch conversations");
                }
            });
        });

        // JavaScript code to handle conversation selection and message display
        const conversationList = document.querySelector(".conversation-list");
        const messages = document.querySelector(".messages");
        const actionButtons = document.querySelector(".action-buttons");

        // Add click event listeners to conversation items
        conversationList.addEventListener("click", event => {
            if (event.target.classList.contains("list-group-item")) {
                selectedConversationId = event.target.id;

                // Get messages for the selected conversation
                $.ajax({
                    type: "GET",
                    url: `/messages/get/${event.target.id}`,
                    contentType: "application/json",
                    success: messages => {
                        if (messages && messages.length > 0) {
                            // Clear existing messages
                            $(".messages").empty();

                            // Iterate through each message and append it to the 'messages' container
                            messages.forEach(messageDTO => {
                                const messageElement = $(
                                    `<p>${messageDTO.userId}: ${messageDTO.messageText} ${messageDTO.sentDatetime}</p>`
                                    );
                                $(".messages").append(messageElement);
                            });
                        } else {
                            // If there are no messages, display a placeholder message
                            $(".messages").html(
                                "<p>No messages available for this conversation.</p>");
                        }
                    },
                    error: () => {
                        console.error("error fetch messages");
                    }
                });

                // Show action buttons for the selected conversation
                actionButtons.style.display = "block";
            }
        });

        const sendButton = document.getElementById("send-btn");
        sendButton.addEventListener("click", () => {
            const messageDTO = {
                conversationId: selectedConversationId,
                messageText: $("#text-area").val()
            }

            $.ajax({
                type: "POST",
                url: "/messages/save",
                contentType: "application/json",
                data: JSON.stringify(messageDTO),
                success: () => {
                    console.log(messageDTO);
                    console.log(JSON.stringify(messageDTO));
                },
                error: () => {
                    console.error("error sending message");
                }
            });
        })

        const leaveConversationButton = document.querySelector(".leave-conversation");
        leaveConversationButton.addEventListener("click", () => {
            // Implement the logic to leave the conversation
            $.ajax({
                type: "DELETE",
                url: `/conversation_user/leave/${selectedConversationId}`,
                contentType: "application/json",
                success: () => {
                    document.getElementById(selectedConversationId).remove();
                    $(".messages").empty();
                    console.log("conversation left");
                },
                error: () => {
                    console.error("error leaving conversation");
                }
            });
        });

        // Add event listener for the "Account Details" button
        const accountDetailsButton = document.querySelector(".account-details");
        accountDetailsButton.addEventListener("click", () => {
            window.location.href = "/account";
        });

        const deleteConversationButton = document.querySelector(".delete-conversation");
        deleteConversationButton.addEventListener("click", event => {
            // Implement the logic to delete the conversation
            $.ajax({
                type: "DELETE",
                url: `/conversations/delete/${selectedConversationId}`,
                contentType: "application/json",
                success: () => {
                    document.getElementById(selectedConversationId).remove();
                    $(".messages").empty();
                    console.log("conversation deleted");
                },
                error: () => {
                    console.error("error deleting conversation");
                }
            });
        });

        const logoutButton = document.getElementById("logout-btn");
        logoutButton.addEventListener("click", () => {
            $.ajax({
                type: "GET",
                url: "/logout",
                contentType: "application/json",
                success: response => {
                    window.location.href = "/";
                    console.log(response);
                    console.log("logout successfully");
                },
                error: () => {
                    console.error("error logout");
                }
            });
        });
    </script>
</body>

</html>